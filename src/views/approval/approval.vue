<script lang="ts" setup>
import { ref, computed } from 'vue';
// sections
import Customers from '@/components/sections/approval/customers/customers.vue';
import Summary from '@/components/sections/approval/summary/summary.vue';
import ApprovalType from '@/components/sections/approval/approvalType/approvalType.vue';
import Guarantor from '@/components/sections/approval/guarantor/guarantor.vue';
import Inquiry from '@/components/sections/approval/inquiry/inquiry.vue';
import Upload from '@/components/sections/approval/upload/upload.vue';
import Draft from '@/components/sections/approval/draft/draft.vue';
import Preview from '@/components/sections/approval/preview/preview.vue';
import { useRouter } from 'vue-router';
import { api } from '@/services/api';
import { useApprovalStore } from '@/stores/approval';
const router = useRouter();
// Define your steps with titles and the corresponding component.
const steps = [
  { title: 'ثبت درخواست هویتی مشتری', component: Customers },
  { title: 'خلاصه درخواست', component: Summary },
  { title: 'اطلاعات نوع درخواست', component: ApprovalType },
  { title: 'اطلاعات ضامن / ضامنین', component: Guarantor },
  { title: 'استعلام', component: Inquiry },
  { title: 'بارگذاری مدارک', component: Upload },
  { title: 'پیشنویس', component: Draft },
  { title: 'نمایش فرم', component: Preview },
];

const stepper = ref(8); // Current step
const totalSteps = steps.length;
const error = ref<string | null>(null);
const approvalStore = useApprovalStore();

// This ref will hold the currently active section's component instance.
const sectionRef = ref<InstanceType<typeof Customers> | null>(null);

// Parent-level loading state for the Next button.
const submitting = ref(false);

// Advance to the next step.
const nextStep = async () => {
  if (stepper.value < totalSteps) {
    stepper.value++;
  } else {
    await router.push('/test/test');
  }
};

// Go to the previous step
const prevStep = () => {
  if (stepper.value > 1) {
    stepper.value--;
  }
};

// Handle form submission logic for the current step
const handleSubmit = async () => {
  if (!sectionRef.value) return;
  submitting.value = true;
  try {
    // Call submitData() method from the child.
    await sectionRef.value.submitData();
    // If successful, move to the next step.
    await nextStep()
  } catch (err) {
    error.value = `${err}`;
  } finally {
    submitting.value = false;
  }
};

// handle make cartable
const handleCartable = async () => {

  try {
    // Call submitData() method from the child.
    const res = await api.cartable.saveCartable(approvalStore.trackingCode);
    if (res.status === 200) {
      await router.push('/cartable');
    }
    // If successful, move to the next step.
    console.log(res);
  } catch (err) {
    error.value = `${err}`;
  } finally {
    submitting.value = false;
  }
};

// Compute the current component based on the current step.
const currentComponent = computed(() => {
  return steps[stepper.value - 1].component;
});
</script>

<template>
  <v-app class="stepperContainer">
    <div class="stepperHeader">
      <span v-for="(step, index) in steps" :key="index">
        <span :class="{ active: stepper === index + 1 }">{{ step.title }}</span>
      <span v-if="index < steps.length - 1"> 🢀 </span>
      </span>
    </div>
    <!-- Add a transition wrapper around the component -->
    <transition name="fade" mode="out-in">
      <!-- Dynamically render the active section and bind a ref -->
      <component style="height: 62vh" :is="currentComponent" ref="sectionRef" />
    </transition>
    <!-- Actions for Next and Previous -->
    <div class="actions">
      <v-btn v-if="stepper <= 7" color="primary" @click="handleSubmit" :loading="submitting"> مرحله بعد </v-btn>
      <v-btn v-if="stepper === 8" color="primary" @click="handleCartable" :loading="submitting"> ایجاد کارتابل </v-btn>
      <v-btn @click="prevStep" :disabled="stepper === 1"> مرحله قبلی </v-btn>
    </div>
    <v-snackbar v-if="error" v-model="error" color="error" timeout="2500">
      {{ error }}
    </v-snackbar>
  </v-app>
</template>

<style scoped>
.stepperContainer {
  height: calc(100vh - 130px); /* Set the height to the full viewport height */
  max-width: 100%; /* Prevent overflow horizontally */
  display: flex;
  flex-direction: column;
  justify-content: space-between; /* Space the header, content, and buttons */
  overflow: hidden; /* Prevent content overflow */
  padding: 15px;
}

.stepperHeader {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 16px;
  width: 100%; /* Ensure the header takes the full width */
}

.stepperHeader span {
  padding: 0 3px;
}

.stepperHeader .active {
  font-weight: bold;
  color: rgb(var(--v-theme-primary));
}

.actions {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
  flex-direction: row-reverse;
}

.v-btn {
  min-width: 100px;
}

/* Styling for Previous and Next buttons */
.v-btn {
  text-align: center;
  justify-content: center;
}

/* Transition effect for step change */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease-in-out;
}

.fade-enter,
.fade-leave-to {
  opacity: 0;
}

/* Ensure the content takes the full remaining height */
.v-stepper__content {
  height: calc(100vh - 100px); /* Adjust the content height for screen */
  overflow-y: auto; /* Add scrolling if needed */
  display: flex;
  flex-direction: column;
  justify-content: center;
}
</style>

